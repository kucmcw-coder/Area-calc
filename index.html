<!DOCTYPE html>
<html>
<head>
    <title>ë©´ì  ì¸¡ì • ì•± - ìƒë‹¨ ì»¨íŠ¸ë¡¤ ë²„ì „</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; overflow: hidden; }
        
        /* ìƒë‹¨ ì»¨íŠ¸ë¡¤ ì˜ì—­ */
        .header-controls {
            position: absolute; top: 0; left: 0; right: 0; z-index: 10;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 10px;
        }

        .search-row { margin-bottom: 8px; }
        #pac-input { 
            width: 100%; padding: 12px; box-sizing: border-box;
            border: 1px solid #ddd; border-radius: 8px; font-size: 16px; 
        }

        .button-grid { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; 
        }

        button { 
            padding: 10px 2px; font-size: 12px; font-weight: bold;
            border: none; border-radius: 6px; cursor: pointer; color: white;
        }

        /* ë²„íŠ¼ ìƒ‰ìƒ í…Œë§ˆ */
        .btn-undo { background: #f1c40f; color: #333; } /* í•œë‹¨ê³„ ì·¨ì†Œ */
        .btn-tracking { background: #3498db; }         /* ì¶”ì  ì‹œì‘ */
        .btn-stop { background: #e74c3c; }             /* ì¶”ì  ì¢…ë£Œ */
        .btn-clear { background: #95a5a6; }            /* ì¸¡ì •ì¹˜ ì´ˆê¸°í™” */
        .btn-reset { background: #2c3e50; }            /* ì „ì²´ ì´ˆê¸°í™” */
        .btn-kakao { background: #fee500; color: #3c1e1e; grid-column: span 3; } /* ì¹´ì¹´ì˜¤ */

        /* ì •ë³´ í‘œì‹œì°½ (ì§€ë„ ìœ„ì— ë°˜íˆ¬ëª…í•˜ê²Œ) */
        .info-overlay {
            position: absolute; bottom: 20px; left: 10px; right: 10px; z-index: 5;
            background: rgba(0, 0, 0, 0.7); color: white;
            padding: 12px; border-radius: 10px; text-align: center;
        }

        #map { height: 100vh; width: 100%; }
    </style>
</head>
<body>

<div class="header-controls">
    <div class="search-row">
        <input id="pac-input" type="text" placeholder="ğŸ” ì£¼ì†Œ ë˜ëŠ” ì§€ë²ˆ ê²€ìƒ‰">
    </div>
    <div class="button-grid">
        <button onclick="undoLastPoint()" class="btn-undo">â†© ì·¨ì†Œ</button>
        <button onclick="startTracking()" class="btn-tracking">ğŸš¶ ì¶”ì ì‹œì‘</button>
        <button onclick="stopTracking()" class="btn-stop">ğŸ›‘ ì¶”ì ì¢…ë£Œ</button>
        
        <button onclick="clearMeasurements()" class="btn-clear">ğŸ“ ì¸¡ì •ì´ˆê¸°í™”</button>
        <button onclick="resetAll()" class="btn-reset">ğŸ—‘ï¸ ì „ì²´ì´ˆê¸°í™”</button>
        <button onclick="saveRecord()" style="background:#27ae60;">ğŸ’¾ ê¸°ë¡ì €ì¥</button>
        
        <button onclick="openKakaoLand()" class="btn-kakao">ğŸ—ºï¸ ì§€ë²ˆ/ì§€ì ë„ ì •ë°€ í™•ì¸ (ì¹´ì¹´ì˜¤ë§µ)</button>
    </div>
</div>

<div id="map"></div>

<div class="info-overlay">
    <div id="measurement-text">ì§€ë„ë¥¼ í„°ì¹˜í•˜ì—¬ ì¸¡ì •ì„ ì‹œì‘í•˜ì„¸ìš”.</div>
    <div id="address-display" style="font-size: 11px; color: #aaa; margin-top: 4px;"></div>
</div>

<script>
    let map, polygon, trackingPath, watchId = null;
    let markers = [];
    let pathCoordinates = [];

    function initMap() {
        const defaultLoc = { lat: 37.5665, lng: 126.9780 };
        map = new google.maps.Map(document.getElementById("map"), {
            zoom: 17,
            center: defaultLoc,
            mapTypeId: 'hybrid',
            gestureHandling: "greedy"
        });

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((pos) => {
                map.setCenter({ lat: pos.coords.latitude, lng: pos.coords.longitude });
            });
        }

        const input = document.getElementById("pac-input");
        const autocomplete = new google.maps.places.Autocomplete(input);
        autocomplete.bindTo("bounds", map);
        autocomplete.addListener("place_changed", () => {
            const place = autocomplete.getPlace();
            if (place.geometry) {
                map.setCenter(place.geometry.location);
                document.getElementById("address-display").innerText = "ğŸ“ " + (place.formatted_address || place.name);
                addPoint(place.geometry.location);
            }
        });

        polygon = new google.maps.Polygon({
            strokeColor: "#FF0000",
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: "#FF0000",
            fillOpacity: 0.3,
            map: map
        });

        map.addListener("click", (e) => addPoint(e.latLng));
    }

    // ì¹´ì¹´ì˜¤ë§µ ì§€ì ë„ ë·° ì—°ë™ í•¨ìˆ˜
    function openKakaoLand() {
        const center = map.getCenter();
        const lat = center.lat();
        const lng = center.lng();
        
        // ì¹´ì¹´ì˜¤ë§µ URL ìŠ¤í‚´: ì§€ì ë„ ë ˆì´ì–´(map_type=TYPE_DISTRICT)ë¥¼ í™œì„±í™”í•œ ìƒíƒœë¡œ ì´ë™
        // íŒŒë¼ë¯¸í„° ì„¤ëª…: 
        // q: ê²€ìƒ‰ì–´ ë˜ëŠ” í‘œì‹œë  ì´ë¦„
        // map_type: TYPE_DISTRICT (ì§€ì í¸ì§‘ë„ ë ˆì´ì–´ í™œì„±í™”)
        const url = `https://map.kakao.com/link/map/ì¸¡ì •ìœ„ì¹˜,${lat},${lng}?map_type=TYPE_DISTRICT`;
        
        window.open(url, '_blank');
    }

    function addPoint(latLng) {
        const marker = new google.maps.Marker({ position: latLng, map: map });
        markers.push(marker);
        polygon.getPath().push(latLng);
        updateDisplay();
    }

    function undoLastPoint() {
        const path = polygon.getPath();
        if (path.getLength() > 0) {
            path.pop();
            const lastMarker = markers.pop();
            if (lastMarker) lastMarker.setMap(null);
            updateDisplay();
        }
    }

    function clearMeasurements() {
        polygon.getPath().clear();
        markers.forEach(m => m.setMap(null));
        markers = [];
        if (trackingPath) trackingPath.setMap(null);
        updateDisplay();
    }

    function resetAll() {
        clearMeasurements();
        pathCoordinates = [];
        if (watchId) stopTracking();
        document.getElementById("measurement-text").innerText = "ëª¨ë“  ì¸¡ì • ì´ˆê¸°í™”ë¨";
        document.getElementById("address-display").innerText = "";
    }

    function updateDisplay() {
        const path = polygon.getPath();
        const res = document.getElementById("measurement-text");
        if (path.getLength() > 2) {
            const area = google.maps.geometry.spherical.computeArea(path);
            res.innerText = `ë©´ì : ${area.toFixed(1)}ã¡ (${(area * 0.3025).toFixed(1)}í‰)`;
        } else if (path.getLength() === 2) {
            const dist = google.maps.geometry.spherical.computeDistanceBetween(path.getAt(0), path.getAt(1));
            res.innerText = `ê±°ë¦¬: ${dist.toFixed(1)}m`;
        } else {
            res.innerText = "ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ì¸¡ì •ì„ ì‹œì‘í•˜ì„¸ìš”.";
        }
    }

    function startTracking() {
        if (watchId) return;
        pathCoordinates = [];
        trackingPath = new google.maps.Polyline({ strokeColor: "#007bff", map: map });
        watchId = navigator.geolocation.watchPosition((pos) => {
            const cur = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            pathCoordinates.push(cur);
            trackingPath.setPath(pathCoordinates);
            map.setCenter(cur);
        }, null, { enableHighAccuracy: true });
        document.getElementById("measurement-text").innerText = "ì‹¤ì‹œê°„ ê²½ë¡œ ì¶”ì  ì¤‘...";
    }

    function stopTracking() {
        if (watchId) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
            if (pathCoordinates.length > 2) {
                const area = google.maps.geometry.spherical.computeArea(pathCoordinates);
                document.getElementById("measurement-text").innerText = `ì¶”ì  ë©´ì : ${area.toFixed(1)}ã¡`;
                new google.maps.Polygon({ paths: pathCoordinates, fillColor: "#007bff", map: map });
            }
        }
    }
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB78_9tya1d38NU2sR1OzU5e6zTySyIKWw&libraries=geometry,drawing,places&callback=initMap" async defer></script>

</body>
</html>