<!DOCTYPE html>
<html>
<head>
    <title>ë©´ì  ì¸¡ì • -kucmcw</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; padding: 0; font-family: 'Pretendard', -apple-system, sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; background: #eee; }

        /* ìƒë‹¨ ê³ ì • ì»¨íŠ¸ë¡¤ëŸ¬ */
        .header-controls {
            position: absolute; top: 0; left: 0; right: 0; z-index: 10;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 10px;
        }

        .search-row { margin-bottom: 8px; }
        #pac-input { 
            width: 100%; padding: 12px; box-sizing: border-box;
            border: 1px solid #ddd; border-radius: 8px; font-size: 16px; 
        }

        .button-grid { 
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; 
        }

        button { 
            padding: 8px 2px; font-size: 11px; font-weight: bold;
            border: none; border-radius: 6px; cursor: pointer; color: white;
        }

        /* ë²„íŠ¼ í…Œë§ˆ */
        .btn-undo { background: #f1c40f; color: #333; }
        .btn-tracking { background: #3498db; }
        .btn-stop { background: #e74c3c; }
        .btn-save { background: #27ae60; }
        .btn-land { background: #8e44ad; grid-column: span 2; } /* ì§€ì ë„ í† ê¸€ */
        .btn-clear { background: #95a5a6; }
        .btn-reset { background: #2c3e50; }
        .btn-kakao { background: #fee500; color: #3c1e1e; grid-column: span 4; margin-top: 4px; }

        /* í•˜ë‹¨ ì •ë³´ì°½ */
        .info-overlay {
            position: absolute; bottom: 30px; left: 15px; right: 15px; z-index: 5;
            background: rgba(0, 0, 0, 0.75); color: white;
            padding: 15px; border-radius: 12px; text-align: center;
            backdrop-filter: blur(5px);
        }

        #measurement-text { font-size: 18px; margin-bottom: 4px; }
        #address-display { font-size: 12px; color: #ffeb3b; }

        /* ì €ì¥ ëª©ë¡ ìŠ¬ë¼ì´ë“œ (ê°„ì†Œí™”) */
        #history-panel {
            position: absolute; bottom: 0; left: 0; right: 0; z-index: 6;
            background: white; max-height: 200px; overflow-y: auto;
            display: none; border-radius: 15px 15px 0 0; padding: 15px;
        }
    </style>
</head>
<body>

<div class="header-controls">
    <div class="search-row">
        <input id="pac-input" type="text" placeholder="ğŸ” ì£¼ì†Œ/ì§€ë²ˆ ê²€ìƒ‰ (ì˜ˆ: ì¢…ë¡œêµ¬ 1ê°€)">
    </div>
    <div class="button-grid">
        <button onclick="undoLastPoint()" class="btn-undo">â†© í•œë‹¨ê³„ ì·¨ì†Œ</button>
        <button onclick="startTracking()" class="btn-tracking">ğŸš¶ ê±¸ìŒ ì¶”ì </button>
        <button onclick="stopTracking()" class="btn-stop">ğŸ›‘ ê±¸ìŒ ì¢…ë£Œ</button>
        <button onclick="saveRecord()" class="btn-save">ğŸ’¾ ì €ì¥</button>
        
        <button onclick="toggleLandLayer()" class="btn-land" id="land-btn">ğŸ—ºï¸ ì§€ì ë„ ë³´ê¸°: OFF</button>
        <button onclick="clearMeasurements()" class="btn-clear">ğŸ“ ì´ˆê¸°í™”</button>
        <button onclick="resetAll()" class="btn-reset">ğŸ—‘ï¸ ì „ì²´ì‚­ì œ</button>
        
        <button onclick="openKakaoLand()" class="btn-kakao">ğŸ—ºï¸ ì¹´ì¹´ì˜¤ë§µì—ì„œ ì§€ë²ˆ ì •ë°€ í™•ì¸</button>
    </div>
</div>

<div id="map"></div>

<div class="info-overlay">
    <div id="measurement-text">ì§€ë„ë¥¼ í„°ì¹˜í•˜ì—¬ ì¸¡ì • ì‹œì‘</div>
    <div id="address-display"></div>
</div>

<script>
    let map, polygon, trackingPath, watchId = null;
    let markers = [];
    let pathCoordinates = [];
    let landLayer = null;
    let isLandLayerVisible = false;

    function initMap() {
        const defaultLoc = { lat: 37.5665, lng: 126.9780 };
        map = new google.maps.Map(document.getElementById("map"), {
            zoom: 17,
            center: defaultLoc,
            mapTypeId: 'hybrid',
            gestureHandling: "greedy",
            disableDefaultUI: true // ì§€ë„ ìœ„ ê¸°ë³¸ ë²„íŠ¼ ì œê±° (ê¹”ë”í•˜ê²Œ)
        });

// ì§€ì ë„ ë ˆì´ì–´ ì„¤ì • (WMS ë°©ì‹ìœ¼ë¡œ ì „ë©´ êµì²´)
landLayer = new google.maps.ImageMapType({
    getTileUrl: function(coord, zoom) {
        const proj = map.getProjection();
        const zpow = Math.pow(2, zoom);
        
        // íƒ€ì¼ì˜ ì¢Œí•˜ë‹¨(sw)ê³¼ ìš°ìƒë‹¨(ne) ì¢Œí‘œ ê³„ì‚°
        const ul = new google.maps.Point(coord.x * 256 / zpow, coord.y * 256 / zpow);
        const lr = new google.maps.Point((coord.x + 1) * 256 / zpow, (coord.y + 1) * 256 / zpow);
        
        const nw = proj.fromPointToLatLng(ul);
        const se = proj.fromPointToLatLng(lr);
        
        // WMS íŒŒë¼ë¯¸í„° êµ¬ì„± (ì§€ì ë„ ì „ìš©)
        const bbox = se.lng() + "," + se.lat() + "," + nw.lng() + "," + nw.lat();
        
        return "https://api.vworld.kr/req/wms?" +
               "SERVICE=WMS&REQUEST=GetMap&V2V=true" +
               "&LAYERS=LP_PA_CBND_BU_EDIT,LP_PA_CBND_ON_EDIT" + // ì§€ì ë„ + ì§€ë²ˆ ë ˆì´ì–´
               "&STYLES=LP_PA_CBND_BU_EDIT,LP_PA_CBND_ON_EDIT" +
               "&FORMAT=image/png&TRANSPARENT=TRUE" +
               "&SRS=EPSG:4326" +
               "&WIDTH=256&HEIGHT=256" +
               "&BBOX=" + bbox +
               "&key=EFCB2642-F3C4-3343-B8E6-F6D7BF27190B";
    },
    tileSize: new google.maps.Size(256, 256),
    isPng: true
});


// ë ˆì´ì–´ë¥¼ ì˜¬ë¦´ ë•Œ ì¤‘ì²© ìˆœì„œ ê°•ì œ ì§€ì •
function toggleLandLayer() {
    const btn = document.getElementById("land-btn");
    
    if (!isLandLayerVisible) {
        // ê¸°ì¡´ì— í˜¹ì‹œ ë‚¨ì•„ìˆì„ì§€ ëª¨ë¥¼ ë ˆì´ì–´ë¥¼ ê¹¨ë—ì´ ë¹„ìš°ê³  ì¶”ê°€
        map.overlayMapTypes.clear(); 
        map.overlayMapTypes.push(landLayer); // ìµœìƒë‹¨ì— ì¶”ê°€
        
        btn.innerText = "ğŸ—ºï¸ ì§€ì ë„ ë³´ê¸°: ON";
        btn.style.background = "#2ecc71";
    } else {
        // ë ˆì´ì–´ ì œê±°
        map.overlayMapTypes.clear();
        
        btn.innerText = "ğŸ—ºï¸ ì§€ì ë„ ë³´ê¸°: OFF";
        btn.style.background = "#8e44ad";
    }
    isLandLayerVisible = !isLandLayerVisible;
}

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((pos) => {
                map.setCenter({ lat: pos.coords.latitude, lng: pos.coords.longitude });
            });
        }

        const input = document.getElementById("pac-input");
        const autocomplete = new google.maps.places.Autocomplete(input);
        autocomplete.addListener("place_changed", () => {
            const place = autocomplete.getPlace();
            if (place.geometry) {
                map.setCenter(place.geometry.location);
                document.getElementById("address-display").innerText = "ğŸ“ " + (place.formatted_address || place.name);
                addPoint(place.geometry.location);
            }
        });

        polygon = new google.maps.Polygon({
            strokeColor: "#FF0000", strokeOpacity: 0.8, strokeWeight: 2,
            fillColor: "#FF0000", fillOpacity: 0.3, map: map
        });

        map.addListener("click", (e) => addPoint(e.latLng));
    }

    function toggleLandLayer() {
        const btn = document.getElementById("land-btn");
        if (!isLandLayerVisible) {
            map.overlayMapTypes.push(landLayer);
            btn.innerText = "ğŸ—ºï¸ ì§€ì ë„ ë³´ê¸°: ON";
            btn.style.background = "#2ecc71";
        } else {
            map.overlayMapTypes.clear();
            btn.innerText = "ğŸ—ºï¸ ì§€ì ë„ ë³´ê¸°: OFF";
            btn.style.background = "#8e44ad";
        }
        isLandLayerVisible = !isLandLayerVisible;
    }

    function addPoint(latLng) {
        const marker = new google.maps.Marker({ position: latLng, map: map });
        markers.push(marker);
        polygon.getPath().push(latLng);
        updateDisplay();
    }

    function undoLastPoint() {
        const path = polygon.getPath();
        if (path.getLength() > 0) {
            path.pop();
            const lastMarker = markers.pop();
            if (lastMarker) lastMarker.setMap(null);
            updateDisplay();
        }
    }

    function updateDisplay() {
        const path = polygon.getPath();
        const res = document.getElementById("measurement-text");
        if (path.getLength() > 2) {
            const area = google.maps.geometry.spherical.computeArea(path);
            res.innerText = `${area.toFixed(1)}ã¡ (${(area * 0.3025).toFixed(1)}í‰)`;
        } else if (path.getLength() === 2) {
            const dist = google.maps.geometry.spherical.computeDistanceBetween(path.getAt(0), path.getAt(1));
            res.innerText = `ê±°ë¦¬: ${dist.toFixed(1)}m`;
        }
    }

    function saveRecord() {
        const data = document.getElementById("measurement-text").innerText;
        if (data.includes("í„°ì¹˜")) return alert("ì¸¡ì •ê°’ì´ ì—†ìŠµë‹ˆë‹¤.");
        alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤: " + data);
        // ì—¬ê¸°ì— localStorage ì €ì¥ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
    }

    function openKakaoLand() {
        const center = map.getCenter();
        window.open(`https://map.kakao.com/link/map/ì¸¡ì •ìœ„ì¹˜,${center.lat()},${center.lng()}?map_type=TYPE_DISTRICT`, '_blank');
    }

    function clearMeasurements() {
        polygon.getPath().clear();
        markers.forEach(m => m.setMap(null));
        markers = [];
        updateDisplay();
    }

    function resetAll() { location.reload(); }

    function startTracking() {
        pathCoordinates = [];
        trackingPath = new google.maps.Polyline({ strokeColor: "#3498db", strokeWeight: 4, map: map });
        watchId = navigator.geolocation.watchPosition((pos) => {
            const cur = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            pathCoordinates.push(cur);
            trackingPath.setPath(pathCoordinates);
            map.setCenter(cur);
        }, null, { enableHighAccuracy: true });
        document.getElementById("measurement-text").innerText = "ì¶”ì  ì¤‘...";
    }

    function stopTracking() {
        if (watchId) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
            if (pathCoordinates.length > 2) {
                const area = google.maps.geometry.spherical.computeArea(pathCoordinates);
                document.getElementById("measurement-text").innerText = `${area.toFixed(1)}ã¡ ì¸¡ì •ì™„ë£Œ`;
                new google.maps.Polygon({ paths: pathCoordinates, fillColor: "#3498db", map: map });
            }
        }
    }
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB78_9tya1d38NU2sR1OzU5e6zTySyIKWw&libraries=geometry,places&callback=initMap" async defer></script>

</body>
</html>