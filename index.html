<!DOCTYPE html>
<html>
<head>
    <title>ë©´ì  ì¸¡ì • ì›¹ì•±</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { height: 70vh; width: 100%; background: #eee; }
        .search-container { padding: 10px; }
        #pac-input { width: 90%; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 4px; }
        .info-panel { padding: 12px; background: #333; color: #fff; text-align: center; font-weight: bold; min-height: 45px; line-height: 1.5; }
        .controls { padding: 10px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; background: #f4f4f4; }
        button { padding: 12px 5px; cursor: pointer; border-radius: 5px; border: none; background: #007bff; color: white; font-weight: bold; font-size: 13px; }
        button.reset { background: #dc3545; }
        button.undo { background: #ffc107; color: black; }
        button.secondary { background: #6c757d; }
        #address-display { font-size: 13px; color: #ffd700; display: block; margin-top: 4px; }
    </style>
</head>
<body>

<div class="search-container">
    <input id="pac-input" type="text" placeholder="ì¥ì†Œë¥¼ ê²€ìƒ‰í•˜ì—¬ ì´ë™ ë° ì£¼ì†Œ í™•ì¸">
</div>

<div class="info-panel">
    <span id="measurement-text">ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ì¸¡ì •ì„ ì‹œì‘í•˜ì„¸ìš”.</span>
    <span id="address-display">ê²€ìƒ‰ëœ ì£¼ì†Œ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</span>
</div>

<div id="map"></div>

<div class="controls">
    <button onclick="undoLastPoint()" class="undo">â†© í•œë‹¨ê³„ ì·¨ì†Œ</button>
    <button onclick="clearMeasurements()" class="secondary">ğŸ“ ì¸¡ì •ì¹˜ ì´ˆê¸°í™”</button>
    <button onclick="resetAll()" class="reset">ğŸ—‘ï¸ ì „ì²´ ì´ˆê¸°í™”</button>
    <button onclick="startTracking()">ğŸš¶ ìœ„ì¹˜ ì¶”ì  ì‹œì‘</button>
    <button onclick="stopTracking()" class="secondary">ğŸ›‘ ì¶”ì  ì¢…ë£Œ</button>
</div>

<script>
    let map, polygon, trackingPath, watchId = null;
    let markers = [];
    let pathCoordinates = [];

    function initMap() {
        const defaultLoc = { lat: 37.5665, lng: 126.9780 };
        
        map = new google.maps.Map(document.getElementById("map"), {
            zoom: 17,
            center: defaultLoc,
            mapTypeId: 'hybrid',
            gestureHandling: "greedy"
        });

        // 1. í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ˆê¸° ì´ë™ (ì£¼ì†Œ í˜¸ì¶œ ì—†ìŒ - ë¹„ìš© ì ˆê°)
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((pos) => {
                map.setCenter({ lat: pos.coords.latitude, lng: pos.coords.longitude });
            });
        }

        // 2. ì£¼ì†Œ ê²€ìƒ‰ ì„¤ì • (ê²€ìƒ‰ ì‹œì—ë§Œ ì£¼ì†Œ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸)
        const input = document.getElementById("pac-input");
        const autocomplete = new google.maps.places.Autocomplete(input);
        autocomplete.bindTo("bounds", map);
        autocomplete.addListener("place_changed", () => {
            const place = autocomplete.getPlace();
            if (place.geometry) {
                map.setCenter(place.geometry.location);
                // ì£¼ì†Œì°½ì— ê²€ìƒ‰ëœ ì •í™•í•œ ëª…ì¹­ í‘œì‹œ
                document.getElementById("address-display").innerText = "ğŸ“ " + (place.formatted_address || place.name);
                addPoint(place.geometry.location);
            }
        });

        polygon = new google.maps.Polygon({
            strokeColor: "#FF0000",
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: "#FF0000",
            fillOpacity: 0.3,
            map: map
        });

        // í´ë¦­ ì‹œ ì ë§Œ ì¶”ê°€ (ì£¼ì†Œ í˜¸ì¶œ APIì¸ Geocoding ìš”ì²­ì„ ì œê±°í•¨)
        map.addListener("click", (e) => addPoint(e.latLng));
    }

    function addPoint(latLng) {
        const marker = new google.maps.Marker({ position: latLng, map: map });
        markers.push(marker);
        polygon.getPath().push(latLng);
        updateDisplay();
    }

    function undoLastPoint() {
        const path = polygon.getPath();
        if (path.getLength() > 0) {
            path.pop();
            const lastMarker = markers.pop();
            if (lastMarker) lastMarker.setMap(null);
            updateDisplay();
        }
    }

    function clearMeasurements() {
        polygon.getPath().clear();
        markers.forEach(m => m.setMap(null));
        markers = [];
        if (trackingPath) trackingPath.setMap(null);
        updateDisplay();
    }

    function resetAll() {
        clearMeasurements();
        pathCoordinates = [];
        if (watchId) stopTracking();
        document.getElementById("measurement-text").innerText = "ëª¨ë“  ì¸¡ì • ì´ˆê¸°í™”ë¨";
        document.getElementById("address-display").innerText = "ê²€ìƒ‰ëœ ì£¼ì†Œ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.";
    }

    function updateDisplay() {
        const path = polygon.getPath();
        const res = document.getElementById("measurement-text");
        
        if (path.getLength() > 2) {
            const area = google.maps.geometry.spherical.computeArea(path);
            res.innerText = `ë©´ì : ${area.toFixed(1)}ã¡ (${(area * 0.3025).toFixed(1)}í‰)`;
        } else if (path.getLength() === 2) {
            const dist = google.maps.geometry.spherical.computeDistanceBetween(path.getAt(0), path.getAt(1));
            res.innerText = `ê±°ë¦¬: ${dist.toFixed(1)}m`;
        } else if (path.getLength() === 1) {
            res.innerText = "ë‹¤ìŒ ì ì„ ì°ìœ¼ì„¸ìš”.";
        } else {
            res.innerText = "ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ì¸¡ì •ì„ ì‹œì‘í•˜ì„¸ìš”.";
        }
    }

    function startTracking() {
        if (watchId) return;
        pathCoordinates = [];
        trackingPath = new google.maps.Polyline({ strokeColor: "#007bff", map: map });
        watchId = navigator.geolocation.watchPosition((pos) => {
            const cur = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            pathCoordinates.push(cur);
            trackingPath.setPath(pathCoordinates);
            map.setCenter(cur);
        }, null, { enableHighAccuracy: true });
        document.getElementById("measurement-text").innerText = "ì‹¤ì‹œê°„ ê²½ë¡œ ì¶”ì  ì¤‘...";
    }

    function stopTracking() {
        if (watchId) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
            if (pathCoordinates.length > 2) {
                const area = google.maps.geometry.spherical.computeArea(pathCoordinates);
                document.getElementById("measurement-text").innerText = `ì¶”ì  ë©´ì : ${area.toFixed(1)}ã¡`;
                new google.maps.Polygon({ paths: pathCoordinates, fillColor: "#007bff", map: map });
            }
        }
    }
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB78_9tya1d38NU2sR1OzU5e6zTySyIKWw&libraries=geometry,drawing,places&callback=initMap" async defer></script>

</body>
</html>